# Maintainer: Denys Sedchenko <x1unix@protonmail.com>

pkgname=go
epoch=2
pkgver=1.17.6
pkgrel=2
pkgdesc='Core compiler tools for the Go programming language'
arch=('x86_64' 'aarch64')
url='https://go.dev/'
license=(BSD)
makedepends=(git go perl)
replaces=(go-pie)
provides=(go-pie)
options=(!strip staticlibs)
source_x86_64=(https://storage.googleapis.com/golang/go$pkgver.darwin-amd64.tar.gz{,.asc})
source_aarch64=(https://storage.googleapis.com/golang/go$pkgver.darwin-arm64.tar.gz{,.asc})
validpgpkeys=('586BAABED3CD7931759415AEB1AD54051EF269EC')
sha256sums_x86_64=('c81555a115fbd99ab1c74e9b3e1d056864c31a4274803381230984f4a70fdf63'
                   'SKIP')
sha256sums_aarch64=('b7397f2bb5f35e87677581fab0441698614ed74d2faf10fc9d82a157945cd4b6'
                    'SKIP')

build() {
  if [ "${CARCH}" = "aarch64" ]; then
    export GOARCH=arm64
  fi
  if [ "${CARCH}" = "amd64" ]; then
    export GOARCH=amd64
    export GOAMD64=v2 # make sure we're building for the right x86-64 version
  fi
  export GOROOT_FINAL="$pkgdir"
  export GOROOT_BOOTSTRAP="$pkgdir"

  cd "$pkgname/src"
  ./make.bash -v
  rm -rf "../gobootstrap"

  # Remove useless files.
  # Breaks patchelf because folder contains weird debug/test files
  rm -rf "./debug/elf/testdata"
  # Binaries built for an incompatible architecture
  rm -rf "./runtime/pprof/testdata"
}

check() {
  export GO_TEST_TIMEOUT_SCALE=3

  cd "$pkgname/src"
  ./run.bash --no-rebuild -v -v -v -k
}

package() {
  cd "$pkgname"

  install -d "$pkgdir/usr/bin" "$pkgdir/usr/lib/go" "$pkgdir/usr/share/doc/go" \
    "$pkgdir/usr/lib/go/pkg/${GOARCH}_amd64_"{dynlink,race}

  cp -a bin pkg src lib misc api test "$pkgdir/usr/lib/go"
  cp -r doc/* "$pkgdir/usr/share/doc/go"

  ln -sf "$pkgdir/usr/bin/go" /usr/local/bin/go
  ln -sf "$pkgdir/usr/bin/gofmt" /usr/local/bin/gofmt

  install -Dm644 VERSION "$pkgdir/usr/lib/go/VERSION"

  rm -rf "$pkgdir/usr/lib/go/pkg/bootstrap" "$pkgdir/usr/lib/go/pkg/tool/*/api"

  # TODO: Figure out if really needed
  rm -rf "$pkgdir"/usr/lib/go/pkg/obj/go-build/*

  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

# vim: ts=2 sw=2 et
